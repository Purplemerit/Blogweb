// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id             String          @id @default(uuid())
  name           String
  email          String          @unique
  password       String
  role           Role            @default(USER)
  emailVerified  Boolean         @default(false)
  avatar         String?
  bio            String?
  website        String?
  twitterHandle  String?
  linkedinUrl    String?

  // OAuth
  provider       String?
  providerId     String?

  // Subscription
  subscriptionPlan  SubscriptionPlan @default(FREE)
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  // Relations
  blogs                Blog[]
  verificationTokens   VerificationToken[]
  refreshTokens        RefreshToken[]
  teamMemberships      TeamMember[]
  activityLogs         ActivityLog[]
  platformConnections  PlatformConnection[]
  settings             UserSettings?
  images               Image[]
  articles             Article[]
  folders              Folder[]
  usageStats           UsageStats?
  collaborations       ArticleCollaborator[]

  @@index([email])
  @@map("users")
}

enum SubscriptionPlan {
  FREE
  STARTER
  CREATOR
  PROFESSIONAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum Role {
  USER
  ADMIN
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      TokenType
  expiresAt DateTime

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// BLOG & CONTENT
// ============================================

model Blog {
  id               String   @id @default(uuid())
  userId           String
  name             String
  slug             String   @unique
  description      String?
  niche            String
  language         String   @default("en")
  audience         String?  // Beginner, Intermediate, Advanced
  publishFrequency String?  // Weekly, Bi-weekly, Monthly

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?

  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles         Article[]
  teamMembers      TeamMember[]

  @@index([userId])
  @@index([slug])
  @@map("blogs")
}

model Article {
  id              String        @id @default(uuid())
  userId          String
  blogId          String?
  folderId        String?
  title           String
  slug            String
  content         String        @db.Text
  excerpt         String?
  featuredImage   String?

  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?
  scheduleAt      DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?
  focusKeyword    String?
  canonicalUrl    String?
  noindex         Boolean       @default(false)
  nofollow        Boolean       @default(false)
  seoScore        Int?
  readabilityScore Int?

  // Stats
  wordCount       Int           @default(0)
  readingTime     Int           @default(0)
  views           Int           @default(0)

  // AI metadata
  toneOfVoice     String?       // Professional, Casual, etc.
  contentFramework String?      // Problem-Agitate-Solve, etc.
  plagiarismScore Int?
  aiDetectionScore Int?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog            Blog?         @relation(fields: [blogId], references: [id], onDelete: SetNull)
  folder          Folder?       @relation(fields: [folderId], references: [id], onDelete: SetNull)
  versions        ArticleVersion[]
  articleTags     ArticleTag[]
  publishRecords  PublishRecord[]
  analytics       Analytics[]
  images          Image[]
  comments        ArticleComment[]
  collaborators   ArticleCollaborator[]

  @@index([userId])
  @@index([blogId])
  @@index([folderId])
  @@index([status])
  @@index([publishedAt])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

model ArticleVersion {
  id        String   @id @default(uuid())
  articleId String
  version   Int
  content   String   @db.Text
  title     String
  excerpt   String?
  createdBy String

  createdAt DateTime @default(now())

  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, version])
  @@index([articleId])
  @@map("article_versions")
}

model Tag {
  id           String       @id @default(uuid())
  name         String       @unique
  slug         String       @unique

  createdAt    DateTime     @default(now())

  articleTags  ArticleTag[]

  @@index([slug])
  @@map("tags")
}

model ArticleTag {
  id        String   @id @default(uuid())
  articleId String
  tagId     String

  createdAt DateTime @default(now())

  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
  @@map("article_tags")
}

// ============================================
// PUBLISHING & PLATFORMS
// ============================================

model PlatformConnection {
  id          String           @id @default(uuid())
  userId      String
  platform    Platform
  status      ConnectionStatus @default(CONNECTED)
  credentials String           // Encrypted JSON
  metadata    Json?            // Platform-specific data (categories, tags, etc.)

  lastSyncAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  publishRecords PublishRecord[]

  @@unique([userId, platform])
  @@index([userId])
  @@map("platform_connections")
}

enum Platform {
  WORDPRESS
  MEDIUM
  GHOST
  LINKEDIN
  DEVTO
  HASHNODE
  WIX
}

enum ConnectionStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

model PublishRecord {
  id                  String    @id @default(uuid())
  articleId           String
  platformConnectionId String
  platform            Platform
  platformPostId      String?
  url                 String?
  status              PublishStatus
  error               String?

  publishedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  article             Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  platformConnection  PlatformConnection @relation(fields: [platformConnectionId], references: [id], onDelete: Cascade)
  analytics           PlatformAnalytics?

  @@index([articleId])
  @@index([platformConnectionId])
  @@index([status])
  @@map("publish_records")
}

enum PublishStatus {
  PUBLISHED
  SCHEDULED
  FAILED
  PENDING
}

model PublishQueue {
  id          String    @id @default(uuid())
  articleId   String
  platforms   String[]  // Array of platform names
  scheduleAt  DateTime?
  status      QueueStatus @default(PENDING)
  attempts    Int       @default(0)
  error       String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@index([status])
  @@index([scheduleAt])
  @@map("publish_queue")
}

enum QueueStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// ANALYTICS
// ============================================

model Analytics {
  id              String   @id @default(uuid())
  articleId       String
  platform        String

  views           Int      @default(0)
  uniqueVisitors  Int      @default(0)
  avgTimeOnPage   Int      @default(0)  // In seconds
  bounceRate      Float    @default(0)
  scrollDepth     Float    @default(0)  // Percentage
  clicks          Int      @default(0)
  shares          Int      @default(0)
  comments        Int      @default(0)

  date            DateTime
  createdAt       DateTime @default(now())

  article         Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, platform, date])
  @@index([articleId])
  @@index([date])
  @@map("analytics")
}

model AnalyticsDaily {
  id        String   @id @default(uuid())
  date      DateTime

  // Aggregated metrics
  totalViews         Int @default(0)
  totalArticles      Int @default(0)
  totalUsers         Int @default(0)
  newUsers           Int @default(0)
  totalRevenue       Float @default(0)

  createdAt DateTime @default(now())

  @@unique([date])
  @@index([date])
  @@map("analytics_daily")
}

model PlatformAnalytics {
  id                  String   @id @default(uuid())
  publishRecordId     String

  // Core metrics
  views               Int      @default(0)
  uniqueVisitors      Int      @default(0)
  likes               Int      @default(0)
  comments            Int      @default(0)
  shares              Int      @default(0)
  bookmarks           Int      @default(0)

  // Engagement metrics
  avgReadTime         Int      @default(0)  // In seconds
  reactions           Json?    // Platform-specific reactions (hearts, unicorns, etc.)

  // External data
  externalData        Json?    // Raw data from platform API

  lastSyncAt          DateTime
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  publishRecord       PublishRecord @relation(fields: [publishRecordId], references: [id], onDelete: Cascade)

  @@unique([publishRecordId])
  @@index([publishRecordId])
  @@index([lastSyncAt])
  @@map("platform_analytics")
}

// ============================================
// TEAM & COLLABORATION
// ============================================

model TeamMember {
  id        String     @id @default(uuid())
  blogId    String
  userId    String
  role      TeamRole

  invitedAt DateTime   @default(now())
  joinedAt  DateTime?

  blog      Blog       @relation(fields: [blogId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([blogId, userId])
  @@index([blogId])
  @@index([userId])
  @@map("team_members")
}

enum TeamRole {
  OWNER
  EDITOR
  CONTRIBUTOR
  VIEWER
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  blogId    String?
  action    String
  metadata  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([blogId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// IMAGES
// ============================================

model Image {
  id          String   @id @default(uuid())
  userId      String
  articleId   String?

  url         String
  thumbnailUrl String?
  filename    String
  mimeType    String
  size        Int      // Bytes
  width       Int?
  height      Int?
  alt         String?
  caption     String?

  source      ImageSource @default(UPLOAD)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article     Article? @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([articleId])
  @@map("images")
}

enum ImageSource {
  UPLOAD
  AI_GENERATED
  STOCK_PEXELS
  STOCK_UNSPLASH
}

// ============================================
// MONETIZATION
// ============================================

model RevenueRecord {
  id          String        @id @default(uuid())
  userId      String
  articleId   String?

  amount      Float
  currency    String        @default("INR")
  source      RevenueSource
  description String?

  date        DateTime
  createdAt   DateTime      @default(now())

  @@index([userId])
  @@index([articleId])
  @@index([date])
  @@map("revenue_records")
}

enum RevenueSource {
  AFFILIATE
  SPONSORED
  ADSENSE
  MEDIUM_PARTNER
  PATREON
  SUBSTACK
  OTHER
}

// ============================================
// SETTINGS
// ============================================

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique

  // Email preferences
  emailOnPublish        Boolean  @default(true)
  emailOnMilestone      Boolean  @default(true)
  emailWeeklyDigest     Boolean  @default(true)
  emailMonthlyReport    Boolean  @default(false)

  // Notification preferences
  pushNotifications     Boolean  @default(true)
  inAppNotifications    Boolean  @default(true)

  // Publishing defaults
  autoPublish           Boolean  @default(false)
  defaultPlatforms      String[] // Array of platform names

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// FOLDERS & ORGANIZATION
// ============================================

model Folder {
  id          String    @id @default(uuid())
  userId      String
  name        String
  description String?
  parentId    String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Folder?   @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]  @relation("FolderHierarchy")
  articles    Article[]

  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

model ArticleComment {
  id         String   @id @default(uuid())
  articleId  String
  userId     String?
  parentId   String?
  content    String   @db.Text
  resolved   Boolean  @default(false)
  position   Json?    // Text position/selection for inline comments

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  parent     ArticleComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    ArticleComment[] @relation("CommentReplies")

  @@index([articleId])
  @@index([parentId])
  @@map("article_comments")
}

model ArticleCollaborator {
  id         String   @id @default(uuid())
  articleId  String
  userId     String
  role       CollaboratorRole @default(VIEWER)
  invitedBy  String
  status     InviteStatus @default(PENDING)

  invitedAt  DateTime @default(now())
  joinedAt   DateTime?
  expiresAt  DateTime?

  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
  @@map("article_collaborators")
}

enum CollaboratorRole {
  OWNER
  EDITOR
  COMMENTER
  VIEWER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model CollaborationSession {
  id         String   @id @default(uuid())
  articleId  String
  userId     String
  socketId   String
  cursor     Json?    // Cursor position
  selection  Json?    // Text selection

  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([articleId])
  @@index([userId])
  @@index([socketId])
  @@map("collaboration_sessions")
}

model ArticleApproval {
  id         String   @id @default(uuid())
  articleId  String
  requestedBy String
  reviewerId  String
  status     ApprovalStatus @default(PENDING)
  comments   String?  @db.Text
  version    Int

  requestedAt DateTime @default(now())
  reviewedAt  DateTime?

  @@index([articleId])
  @@index([requestedBy])
  @@index([reviewerId])
  @@index([status])
  @@map("article_approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

// ============================================
// USAGE TRACKING & LIMITS
// ============================================

model UsageStats {
  id                    String   @id @default(uuid())
  userId                String   @unique

  // Monthly limits based on plan
  articlesCreatedThisMonth   Int @default(0)
  aiGenerationsThisMonth     Int @default(0)
  imagesGeneratedThisMonth   Int @default(0)
  plagiarismChecksThisMonth  Int @default(0)

  // Total counts
  totalArticles         Int      @default(0)
  totalPublished        Int      @default(0)
  totalViews            Int      @default(0)

  lastResetDate         DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_stats")
}
